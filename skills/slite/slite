#!/bin/bash
# Slite API operations - Works with any AI agent

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CONFIG_FILE="$SCRIPT_DIR/.env"
source "$CONFIG_FILE" 2>/dev/null

API_BASE="https://api.slite.com/v1"

if [[ -z "$SLITE_API_KEY" ]]; then
    echo "Error: Not configured. Create $CONFIG_FILE with SLITE_API_KEY"
    exit 1
fi

# GET request helper
api_get() {
    local endpoint="$1"
    shift
    curl -s -X GET "$API_BASE$endpoint" \
        -H "Authorization: Bearer $SLITE_API_KEY" \
        -H "Content-Type: application/json" \
        "$@"
}

# POST request helper
api_post() {
    local endpoint="$1"
    local data="$2"
    curl -s -X POST "$API_BASE$endpoint" \
        -H "Authorization: Bearer $SLITE_API_KEY" \
        -H "Content-Type: application/json" \
        -d "$data"
}

# PUT request helper
api_put() {
    local endpoint="$1"
    local data="$2"
    curl -s -X PUT "$API_BASE$endpoint" \
        -H "Authorization: Bearer $SLITE_API_KEY" \
        -H "Content-Type: application/json" \
        -d "$data"
}

# DELETE request helper
api_delete() {
    local endpoint="$1"
    curl -s -X DELETE "$API_BASE$endpoint" \
        -H "Authorization: Bearer $SLITE_API_KEY" \
        -H "Content-Type: application/json"
}

# URL encode helper
url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('$1'))"
}

# JSON escape helper - properly escapes content for JSON
json_escape() {
    python3 -c "import json,sys; print(json.dumps(sys.stdin.read())[1:-1])"
}

# Commands
cmd_me() {
    api_get "/me"
}

cmd_search() {
    local query=""
    local parent_id=""
    local depth=""
    local include_archived=""
    local after=""
    local page=""
    local limit=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --parent) parent_id="$2"; shift 2 ;;
            --depth) depth="$2"; shift 2 ;;
            --include-archived) include_archived="true"; shift ;;
            --after) after="$2"; shift 2 ;;
            --page) page="$2"; shift 2 ;;
            --limit) limit="$2"; shift 2 ;;
            *) query="$1"; shift ;;
        esac
    done

    local endpoint="/search-notes?"
    [[ -n "$query" ]] && endpoint="${endpoint}query=$(url_encode "$query")&"
    [[ -n "$parent_id" ]] && endpoint="${endpoint}parentNoteId=$parent_id&"
    [[ -n "$depth" ]] && endpoint="${endpoint}depth=$depth&"
    [[ -n "$include_archived" ]] && endpoint="${endpoint}includeArchived=true&"
    [[ -n "$after" ]] && endpoint="${endpoint}lastEditedAfter=$after&"
    [[ -n "$page" ]] && endpoint="${endpoint}page=$page&"
    [[ -n "$limit" ]] && endpoint="${endpoint}hitsPerPage=$limit&"

    endpoint="${endpoint%&}"
    api_get "$endpoint"
}

cmd_ask() {
    local question=""
    local parent_id=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --parent) parent_id="$2"; shift 2 ;;
            *) question="$1"; shift ;;
        esac
    done

    local endpoint="/ask?question=$(url_encode "$question")"
    [[ -n "$parent_id" ]] && endpoint="${endpoint}&parentNoteId=$parent_id"

    api_get "$endpoint"
}

cmd_list_notes() {
    local parent_id="$1"
    if [[ -n "$parent_id" ]]; then
        api_get "/notes?parentNoteId=$parent_id"
    else
        api_get "/notes"
    fi
}

cmd_get_note() {
    local note_id="$1"
    local format="${2:-md}"
    api_get "/notes/$note_id?format=$format"
}

cmd_get_note_children() {
    local note_id="$1"
    api_get "/notes/$note_id/children"
}

cmd_tree() {
    local note_id="$1"
    local max_depth="${2:-3}"
    local current_depth="${3:-0}"
    local prefix="${4:-}"

    [[ $current_depth -ge $max_depth ]] && return

    local response=$(api_get "/notes/$note_id/children")
    local notes=$(echo "$response" | python3 -c "
import sys, json
data = json.load(sys.stdin)
notes = data.get('notes', [])
for i, note in enumerate(notes):
    is_last = i == len(notes) - 1
    print(f\"{note['id']}|{note['title']}|{is_last}\")
" 2>/dev/null)

    while IFS='|' read -r child_id title is_last; do
        [[ -z "$child_id" ]] && continue

        local connector="├── "
        local next_prefix="${prefix}│   "
        if [[ "$is_last" == "True" ]]; then
            connector="└── "
            next_prefix="${prefix}    "
        fi

        echo "${prefix}${connector}${title} (${child_id})"

        cmd_tree "$child_id" "$max_depth" $((current_depth + 1)) "$next_prefix"
    done <<< "$notes"
}

cmd_search_users() {
    local query="$1"
    local include_archived=""

    if [[ "$2" == "--include-archived" ]]; then
        include_archived="&includeArchived=true"
    fi

    api_get "/users?query=$(url_encode "$query")$include_archived"
}

cmd_create_note() {
    local title="$1"
    local markdown="$2"
    local parent_id="$3"

    local json="{\"title\": \"$title\""
    [[ -n "$markdown" ]] && json="$json, \"markdown\": \"$markdown\""
    [[ -n "$parent_id" ]] && json="$json, \"parentNoteId\": \"$parent_id\""
    json="$json}"

    api_post "/notes" "$json"
}

cmd_update_note() {
    local note_id="$1"
    local title="$2"
    local markdown="$3"

    # WARNING: This REPLACES the entire note content!
    # Use append/prepend to add content without losing existing content.

    local json="{"
    local first=true
    if [[ -n "$title" ]]; then
        local escaped_title=$(echo -n "$title" | json_escape)
        json="$json\"title\": \"$escaped_title\""
        first=false
    fi
    if [[ -n "$markdown" ]]; then
        [[ "$first" == false ]] && json="$json, "
        local escaped_md=$(echo -n "$markdown" | json_escape)
        json="$json\"markdown\": \"$escaped_md\""
    fi
    json="$json}"

    api_put "/notes/$note_id" "$json"
}

cmd_append_note() {
    local note_id="$1"
    local markdown="$2"

    # Get current content
    local current=$(api_get "/notes/$note_id?format=md" | python3 -c "import sys,json; print(json.load(sys.stdin).get('content',''))" 2>/dev/null)

    # Append new content
    local new_content="${current}

${markdown}"

    local escaped_md=$(echo -n "$new_content" | json_escape)
    api_put "/notes/$note_id" "{\"markdown\": \"$escaped_md\"}"
}

cmd_prepend_note() {
    local note_id="$1"
    local markdown="$2"

    # Get current content
    local current=$(api_get "/notes/$note_id?format=md" | python3 -c "import sys,json; print(json.load(sys.stdin).get('content',''))" 2>/dev/null)

    # Prepend new content
    local new_content="${markdown}

${current}"

    local escaped_md=$(echo -n "$new_content" | json_escape)
    api_put "/notes/$note_id" "{\"markdown\": \"$escaped_md\"}"
}

cmd_delete_note() {
    local note_id="$1"
    api_delete "/notes/$note_id"
}

cmd_archive_note() {
    local note_id="$1"
    local archived="${2:-true}"
    api_put "/notes/$note_id/archived" "{\"archived\": $archived}"
}

cmd_verify_note() {
    local note_id="$1"
    local until_date="$2"
    if [[ -n "$until_date" ]]; then
        api_put "/notes/$note_id/verify" "{\"until\": \"$until_date\"}"
    else
        api_put "/notes/$note_id/verify" "{\"until\": null}"
    fi
}

cmd_flag_outdated() {
    local note_id="$1"
    local reason="$2"
    api_put "/notes/$note_id/flag-as-outdated" "{\"reason\": \"$reason\"}"
}

# Main dispatcher
case "$1" in
    me)
        cmd_me
        ;;
    search)
        shift
        cmd_search "$@"
        ;;
    ask)
        shift
        cmd_ask "$@"
        ;;
    list)
        cmd_list_notes "$2"
        ;;
    get)
        cmd_get_note "$2" "$3"
        ;;
    children)
        cmd_get_note_children "$2"
        ;;
    tree)
        cmd_tree "$2" "$3"
        ;;
    search-users)
        cmd_search_users "$2" "$3"
        ;;
    create)
        cmd_create_note "$2" "$3" "$4"
        ;;
    update)
        cmd_update_note "$2" "$3" "$4"
        ;;
    append)
        cmd_append_note "$2" "$3"
        ;;
    prepend)
        cmd_prepend_note "$2" "$3"
        ;;
    delete)
        cmd_delete_note "$2"
        ;;
    archive)
        cmd_archive_note "$2" "$3"
        ;;
    verify)
        cmd_verify_note "$2" "$3"
        ;;
    outdated)
        cmd_flag_outdated "$2" "$3"
        ;;
    *)
        echo "Slite API Commands:"
        echo ""
        echo "  READ:"
        echo "  me                              - Get current user info"
        echo "  search <query> [flags]          - Search notes"
        echo "       --parent <id>              - Filter by parent note"
        echo "       --depth <n>                - Search depth (1-3)"
        echo "       --include-archived         - Include archived notes"
        echo "       --after <date>             - Notes edited after date (ISO)"
        echo "       --page <n>                 - Page number"
        echo "       --limit <n>                - Results per page"
        echo "  ask <question> [--parent <id>]  - Ask AI a question"
        echo "  list [parentId]                 - List notes"
        echo "  get <noteId> [md|html]          - Get note content"
        echo "  children <noteId>               - Get direct children"
        echo "  tree <noteId> [depth]           - Show note hierarchy (default depth: 3)"
        echo "  search-users <query>            - Search users"
        echo ""
        echo "  WRITE:"
        echo "  create <title> [md] [parent]    - Create note"
        echo "  append <noteId> <md>            - Add content to END of note (SAFE)"
        echo "  prepend <noteId> <md>           - Add content to START of note (SAFE)"
        echo "  update <noteId> [title] [md]    - REPLACE entire note (DANGEROUS!)"
        echo "  delete <noteId>                 - Delete note (irreversible!)"
        echo "  archive <noteId> [true|false]   - Archive/unarchive note"
        echo "  verify <noteId> [until]         - Mark note as verified"
        echo "  outdated <noteId> <reason>      - Flag note as outdated"
        exit 1
        ;;
esac
