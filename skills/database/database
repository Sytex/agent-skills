#!/usr/bin/env bash
set -euo pipefail

# Database - Read-only MySQL/MariaDB client - Multi-database support
# This skill provides safe, read-only access to Sytex databases

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Parse global flags first
SELECTED_DB=""
SELECTED_DATABASE=""
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --db)
            SELECTED_DB="$2"
            shift 2
            ;;
        --database)
            SELECTED_DATABASE="$2"
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done
set -- "${ARGS[@]}"

# Show usage
cmd_help() {
    cat << EOF
${BLUE}Database - Read-only MySQL/MariaDB Client${NC}

${YELLOW}Usage:${NC}
  database [--db <connection>] [--database <dbname>] <command> [arguments]

${YELLOW}Commands:${NC}
  ${GREEN}dbs${NC}                     List configured database connections
  ${GREEN}test${NC}                    Test database connection
  ${GREEN}show-databases${NC}          List available databases on the server
  ${GREEN}tables${NC}                  List all tables in the selected database
  ${GREEN}describe${NC} <table>        Show schema and indexes for a table
  ${GREEN}query${NC} <sql> [format]    Execute a SELECT query (formats: table, json, csv)
  ${GREEN}stats${NC}                   Show database statistics
  ${GREEN}help${NC}                    Show this help message

${YELLOW}Examples:${NC}
  database dbs                                                      # List connections
  database test                                                     # Test connection
  database --db local show-databases                                # List databases
  database --db local --database sytex_telesoluciones tables        # List tables
  database --db local --database sytex_telesoluciones describe projects_task
  database --db local --database sytex_telesoluciones query "SELECT * FROM projects_task LIMIT 5"
  database --db local --database sytex_telesoluciones stats

${YELLOW}Notes:${NC}
  - Only SELECT, SHOW, DESCRIBE, and EXPLAIN queries are allowed
  - All queries are read-only for safety
  - Use --db flag to select a specific database, otherwise the default is used
EOF
}

# Check if we need credentials (not needed for help command)
if [[ "${1:-}" == "help" ]] || [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cmd_help
    exit 0
fi

# Load environment variables
if [[ -f "$ENV_FILE" ]]; then
    set -a
    source "$ENV_FILE"
    set +a
else
    echo -e "${RED}Error: .env file not found at $ENV_FILE${NC}"
    echo "Run the installer to configure database credentials."
    exit 1
fi

# Function to get DB config
get_db_config() {
    local db_name="$1"
    local field="$2"

    # Config format: DATABASE_DB_<NAME>_HOST, DATABASE_DB_<NAME>_PORT, etc.
    # (skill-id "database" becomes "SYTEX_DB" in the installer)
    local name_upper=$(echo "$db_name" | tr '[:lower:]-' '[:upper:]_')
    local var_name="DATABASE_DB_${name_upper}_${field}"
    # Return empty string if variable doesn't exist
    echo "${!var_name:-}"
}

# Get list of configured databases
get_configured_dbs() {
    grep -o 'DATABASE_DB_[A-Z0-9_]*_HOST' "$ENV_FILE" 2>/dev/null | sed 's/^DATABASE_DB_//' | sed 's/_HOST$//' | tr '[:upper:]_' '[:lower:]-' | sort -u
}

# Resolve which database to use
resolve_db() {
    if [[ -n "$SELECTED_DB" ]]; then
        echo "$SELECTED_DB"
        return
    fi

    if [[ -n "${DATABASE_DEFAULT_DB:-}" ]]; then
        echo "$DATABASE_DEFAULT_DB"
        return
    fi

    # Use first configured database
    get_configured_dbs | head -1
}

# Set up DB connection for current database
DB=$(resolve_db)

if [[ -z "$DB" ]]; then
    echo -e "${RED}Error: No databases configured. Run the installer to add one.${NC}"
    exit 1
fi

DB_HOST=$(get_db_config "$DB" "HOST")
DB_PORT=$(get_db_config "$DB" "PORT")
DB_USER=$(get_db_config "$DB" "USER")
DB_PASSWORD=$(get_db_config "$DB" "PASSWORD")

if [[ -z "$DB_HOST" ]]; then
    echo -e "${RED}Error: Database connection '$DB' not found in config.${NC}"
    echo "Configured connections: $(get_configured_dbs | tr '\n' ' ')"
    exit 1
fi

DB_PORT="${DB_PORT:-3306}"

# Use selected database if provided, otherwise leave empty (for show-databases command)
DB_NAME="$SELECTED_DATABASE"

# Check if mysql client is installed
if ! command -v mysql &> /dev/null; then
    echo -e "${RED}Error: mysql client not found${NC}"
    echo "Install it with: brew install mysql-client (macOS) or apt-get install mysql-client (Linux)"
    exit 1
fi

# Execute MySQL query with proper error handling
execute_query() {
    local query="$1"
    local format="${2:-table}"  # table, json, csv

    local mysql_opts=(
        --host="$DB_HOST"
        --port="$DB_PORT"
        --user="$DB_USER"
        --password="$DB_PASSWORD"
    )

    # Add database if specified
    if [[ -n "$DB_NAME" ]]; then
        mysql_opts+=(--database="$DB_NAME")
    fi

    case "$format" in
        json)
            mysql_opts+=(--json)
            ;;
        csv)
            mysql_opts+=(--batch --skip-column-names)
            ;;
        table)
            mysql_opts+=(--table)
            ;;
    esac

    if ! echo "$query" | mysql "${mysql_opts[@]}" 2>&1; then
        return 1
    fi
}

# List configured databases
cmd_dbs() {
    echo -e "${BLUE}Configured databases:${NC}"
    echo ""
    local current_db=$(resolve_db)
    while IFS= read -r db_name; do
        local host=$(get_db_config "$db_name" "HOST")
        local port=$(get_db_config "$db_name" "PORT")
        local database=$(get_db_config "$db_name" "DATABASE")
        local user=$(get_db_config "$db_name" "USER")
        local password=$(get_db_config "$db_name" "PASSWORD")
        local marker=""
        [[ "$db_name" == "$current_db" ]] && marker=" ${GREEN}(active)${NC}"
        echo -e "  ${YELLOW}●${NC} $db_name$marker"
        echo -e "    Host: $host:${port:-3306}"
        echo -e "    Database: $database"
        echo -e "    User: $user"

        # Test connection
        local test_result=$(mysql -h "$host" -P "${port:-3306}" -u "$user" -p"$password" --database="$database" -e "SELECT 1;" 2>&1)
        if echo "$test_result" | grep -q "^1$"; then
            echo -e "    Status: ${GREEN}✓ connected${NC}"
        else
            echo -e "    Status: ${RED}✗ error${NC}"
        fi
        echo ""
    done < <(get_configured_dbs)
}

# Test connection
cmd_test() {
    echo -e "${BLUE}Testing database connection...${NC}"
    if execute_query "SELECT 1 AS connection_test;" > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Connection successful${NC}"
        echo -e "${BLUE}Connection: ${NC}$DB"
        echo -e "${BLUE}Host: ${NC}$DB_HOST:$DB_PORT"
        echo -e "${BLUE}User: ${NC}$DB_USER"
        if [[ -n "$DB_NAME" ]]; then
            echo -e "${BLUE}Database: ${NC}$DB_NAME"
        fi
    else
        echo -e "${RED}✗ Connection failed${NC}"
        exit 1
    fi
}

# Show available databases
cmd_show_databases() {
    echo -e "${BLUE}Available databases on '$DB':${NC}"
    execute_query "SHOW DATABASES;"
}

# List all tables
cmd_tables() {
    if [[ -z "$DB_NAME" ]]; then
        echo -e "${RED}Error: No database selected. Use --database <name>${NC}"
        echo "Run 'database show-databases' to see available databases"
        exit 1
    fi
    echo -e "${BLUE}Tables in database '$DB_NAME':${NC}"
    execute_query "SHOW TABLES;"
}

# Describe table schema
cmd_describe() {
    if [[ -z "$DB_NAME" ]]; then
        echo -e "${RED}Error: No database selected. Use --database <name>${NC}"
        echo "Run 'database show-databases' to see available databases"
        exit 1
    fi

    local table="$1"
    if [[ -z "$table" ]]; then
        echo -e "${RED}Error: Table name required${NC}"
        echo "Usage: database --database <db> describe <table_name>"
        exit 1
    fi

    echo -e "${BLUE}Schema for table '$table':${NC}"
    execute_query "DESCRIBE \`$table\`;"

    echo ""
    echo -e "${BLUE}Indexes for table '$table':${NC}"
    execute_query "SHOW INDEXES FROM \`$table\`;"
}

# Execute a custom query
cmd_query() {
    if [[ -z "$DB_NAME" ]]; then
        echo -e "${RED}Error: No database selected. Use --database <name>${NC}"
        echo "Run 'database show-databases' to see available databases"
        exit 1
    fi

    local query="$1"
    local format="${2:-table}"

    if [[ -z "$query" ]]; then
        echo -e "${RED}Error: Query required${NC}"
        echo "Usage: database --database <db> query \"SELECT * FROM table LIMIT 10\" [format]"
        echo "Formats: table (default), json, csv"
        exit 1
    fi

    # Validate it's a SELECT query (read-only)
    if ! echo "$query" | grep -iE '^\s*(SELECT|SHOW|DESCRIBE|EXPLAIN)' > /dev/null; then
        echo -e "${RED}Error: Only SELECT, SHOW, DESCRIBE, and EXPLAIN queries are allowed${NC}"
        exit 1
    fi

    execute_query "$query" "$format"
}

cmd_stats() {
    if [[ -z "$DB_NAME" ]]; then
        echo -e "${RED}Error: No database selected. Use --database <name>${NC}"
        echo "Run 'database show-databases' to see available databases"
        exit 1
    fi

    echo -e "${BLUE}Database statistics for '$DB_NAME':${NC}"
    echo ""

    echo -e "${BLUE}Table row counts:${NC}"
    execute_query "
        SELECT
            table_name AS 'Table',
            table_rows AS 'Approximate Rows'
        FROM information_schema.tables
        WHERE table_schema = '$DB_NAME'
        ORDER BY table_rows DESC;
    "
}

# Main command dispatcher
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        dbs|databases)
            cmd_dbs
            ;;
        test)
            cmd_test
            ;;
        show-databases)
            cmd_show_databases
            ;;
        tables|list)
            cmd_tables
            ;;
        describe|desc|schema)
            cmd_describe "$@"
            ;;
        query|q)
            cmd_query "$@"
            ;;
        stats|statistics)
            cmd_stats
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}Error: Unknown command '$cmd'${NC}"
            echo "Run 'database help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
