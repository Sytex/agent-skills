#!/bin/bash
# Linear API CLI

CONFIG_FILE="$HOME/.claude/skills/linear/.env"
source "$CONFIG_FILE" 2>/dev/null

if [[ -z "$LINEAR_API_KEY" ]]; then
    echo "Error: Linear not configured."
    echo "Run: ~/.claude/skills/linear/config.sh setup"
    exit 1
fi

API_URL="https://api.linear.app/graphql"

# GraphQL request helper
gql() {
    local query="$1"
    curl -s -X POST "$API_URL" \
        -H "Content-Type: application/json" \
        -H "Authorization: $LINEAR_API_KEY" \
        -d "{\"query\": \"$query\"}"
}

gql_vars() {
    local query="$1"
    local vars="$2"
    curl -s -X POST "$API_URL" \
        -H "Content-Type: application/json" \
        -H "Authorization: $LINEAR_API_KEY" \
        -d "{\"query\": \"$query\", \"variables\": $vars}"
}

# === ME ===

cmd_me() {
    gql "{ viewer { id name email } }"
}

# === TEAMS ===

cmd_teams() {
    gql "{ teams { nodes { id key name } } }"
}

cmd_team() {
    local id="$1"
    [[ -z "$id" ]] && echo "Error: team ID or key required" && exit 1
    gql "{ team(id: \\\"$id\\\") { id key name description states { nodes { id name type } } } }"
}

# === ISSUES ===

cmd_issues() {
    local filter=""
    local limit=25
    local team=""
    local assignee=""
    local state=""
    local project=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) limit="$2"; shift 2 ;;
            --team) team="$2"; shift 2 ;;
            --assignee) assignee="$2"; shift 2 ;;
            --state) state="$2"; shift 2 ;;
            --project) project="$2"; shift 2 ;;
            --me) assignee="me"; shift ;;
            *) shift ;;
        esac
    done

    # Build filter
    local filters=()
    [[ -n "$team" ]] && filters+=("team: { key: { eq: \\\"$team\\\" } }")
    [[ "$assignee" == "me" ]] && filters+=("assignee: { isMe: { eq: true } }")
    [[ -n "$assignee" && "$assignee" != "me" ]] && filters+=("assignee: { name: { containsIgnoreCase: \\\"$assignee\\\" } }")
    [[ -n "$state" ]] && filters+=("state: { name: { containsIgnoreCase: \\\"$state\\\" } }")
    [[ -n "$project" ]] && filters+=("project: { name: { containsIgnoreCase: \\\"$project\\\" } }")

    if [[ ${#filters[@]} -gt 0 ]]; then
        filter="filter: { $(IFS=', '; echo "${filters[*]}") }"
    fi

    gql "{ issues(first: $limit, $filter orderBy: updatedAt) { nodes { id identifier title state { name } assignee { name } priority createdAt } } }"
}

cmd_issue() {
    local id="$1"
    [[ -z "$id" ]] && echo "Error: issue ID or identifier required" && exit 1

    # Check if it's an identifier (e.g., TEAM-123) or UUID
    if [[ "$id" =~ ^[A-Z]+-[0-9]+$ ]]; then
        gql "{ issueSearch(query: \\\"$id\\\", first: 1) { nodes { id identifier title description state { name } assignee { name } project { name } priority priorityLabel labels { nodes { name } } createdAt updatedAt comments { nodes { body user { name } createdAt } } } } }"
    else
        gql "{ issue(id: \\\"$id\\\") { id identifier title description state { name } assignee { name } project { name } priority priorityLabel labels { nodes { name } } createdAt updatedAt comments { nodes { body user { name } createdAt } } } }"
    fi
}

cmd_issue_create() {
    local title="$1"
    local team="$2"
    local description="${3:-}"

    [[ -z "$title" ]] && echo "Error: title required" && exit 1
    [[ -z "$team" ]] && echo "Error: team key required" && exit 1

    # Escape description for JSON
    description=$(echo "$description" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

    local mutation="mutation { issueCreate(input: { title: \\\"$title\\\", teamId: \\\"$team\\\", description: \\\"$description\\\" }) { success issue { id identifier title url } } }"
    gql "$mutation"
}

cmd_issue_update() {
    local id="$1"
    local field="$2"
    local value="$3"

    [[ -z "$id" ]] && echo "Error: issue ID required" && exit 1
    [[ -z "$field" ]] && echo "Error: field required (title, description, stateId, assigneeId, priority)" && exit 1
    [[ -z "$value" ]] && echo "Error: value required" && exit 1

    local input=""
    case "$field" in
        title|description) input="$field: \\\"$value\\\"" ;;
        stateId|assigneeId|projectId) input="$field: \\\"$value\\\"" ;;
        priority) input="priority: $value" ;;
        *) echo "Error: unknown field $field" && exit 1 ;;
    esac

    gql "mutation { issueUpdate(id: \\\"$id\\\", input: { $input }) { success issue { id identifier title state { name } } } }"
}

# === PROJECTS ===

cmd_projects() {
    local limit=25
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) limit="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    gql "{ projects(first: $limit) { nodes { id name state progress { scope { total completed } } lead { name } } } }"
}

cmd_project() {
    local id="$1"
    [[ -z "$id" ]] && echo "Error: project ID required" && exit 1
    gql "{ project(id: \\\"$id\\\") { id name description state startDate targetDate progress { scope { total completed } } lead { name } issues { nodes { id identifier title state { name } } } } }"
}

# === CYCLES ===

cmd_cycles() {
    local team="$1"
    [[ -z "$team" ]] && echo "Error: team key required" && exit 1
    gql "{ team(id: \\\"$team\\\") { cycles(first: 10, orderBy: startsAt) { nodes { id number name startsAt endsAt progress { scope { total completed } } } } } }"
}

# === STATES ===

cmd_states() {
    local team="$1"
    [[ -z "$team" ]] && echo "Error: team key required" && exit 1
    gql "{ team(id: \\\"$team\\\") { states { nodes { id name type position } } } }"
}

# === SEARCH ===

cmd_search() {
    local query="$1"
    local limit="${2:-10}"
    [[ -z "$query" ]] && echo "Error: search query required" && exit 1
    gql "{ issueSearch(query: \\\"$query\\\", first: $limit) { nodes { id identifier title state { name } assignee { name } } } }"
}

# === COMMENTS ===

cmd_comment() {
    local issue_id="$1"
    local body="$2"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1
    [[ -z "$body" ]] && echo "Error: comment body required" && exit 1

    body=$(echo "$body" | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')
    gql "mutation { commentCreate(input: { issueId: \\\"$issue_id\\\", body: \\\"$body\\\" }) { success comment { id body } } }"
}

# === GENERIC ===

cmd_query() {
    local query="$1"
    [[ -z "$query" ]] && echo "Error: GraphQL query required" && exit 1
    gql "$query"
}

# === MAIN ===

show_help() {
    echo "Linear API CLI"
    echo ""
    echo "ACCOUNT:"
    echo "  me                              Get current user info"
    echo ""
    echo "TEAMS:"
    echo "  teams                           List all teams"
    echo "  team <id|key>                   Get team details and states"
    echo "  states <team-key>               List workflow states for a team"
    echo ""
    echo "ISSUES:"
    echo "  issues [flags]                  List issues"
    echo "    --limit <n>                   Max results (default: 25)"
    echo "    --team <key>                  Filter by team (e.g., ENG)"
    echo "    --me                          Assigned to me"
    echo "    --assignee <name>             Filter by assignee name"
    echo "    --state <name>                Filter by state name"
    echo "    --project <name>              Filter by project name"
    echo "  issue <id|identifier>           Get issue details (e.g., ENG-123)"
    echo "  issue-create <title> <team>     Create issue"
    echo "  issue-update <id> <field> <val> Update issue field"
    echo "  search <query> [limit]          Search issues"
    echo "  comment <issue-id> <body>       Add comment to issue"
    echo ""
    echo "PROJECTS:"
    echo "  projects [--limit n]            List projects"
    echo "  project <id>                    Get project details"
    echo ""
    echo "CYCLES:"
    echo "  cycles <team-key>               List cycles for a team"
    echo ""
    echo "GENERIC:"
    echo "  query <graphql>                 Run raw GraphQL query"
}

case "$1" in
    me) cmd_me ;;
    teams) cmd_teams ;;
    team) cmd_team "$2" ;;
    states) cmd_states "$2" ;;
    issues) shift; cmd_issues "$@" ;;
    issue) cmd_issue "$2" ;;
    issue-create) cmd_issue_create "$2" "$3" "$4" ;;
    issue-update) cmd_issue_update "$2" "$3" "$4" ;;
    search) cmd_search "$2" "$3" ;;
    comment) cmd_comment "$2" "$3" ;;
    projects) shift; cmd_projects "$@" ;;
    project) cmd_project "$2" ;;
    cycles) cmd_cycles "$2" ;;
    query) cmd_query "$2" ;;
    *) show_help ;;
esac
