#!/usr/bin/env bash
set -euo pipefail

# Sytex Database - Read-only MySQL/MariaDB client
# This skill provides safe, read-only access to the Sytex database

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ENV_FILE="$SCRIPT_DIR/.env"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Show usage
cmd_help() {
    cat << EOF
${BLUE}Sytex Database - Read-only MySQL/MariaDB Client${NC}

${YELLOW}Usage:${NC}
  sytex-db <command> [arguments]

${YELLOW}Commands:${NC}
  ${GREEN}test${NC}                    Test database connection
  ${GREEN}tables${NC}                  List all tables in the database
  ${GREEN}describe${NC} <table>        Show schema and indexes for a table
  ${GREEN}query${NC} <sql> [format]    Execute a SELECT query (formats: table, json, csv)
  ${GREEN}stats${NC}                   Show database statistics

  ${YELLOW}Predefined queries:${NC}
  ${GREEN}tasks${NC} [limit]           Show recent tasks (default: 20)
  ${GREEN}projects${NC} [limit]        Show recent projects (default: 20)
  ${GREEN}users${NC} [limit]           Show users (default: 50)

  ${GREEN}help${NC}                    Show this help message

${YELLOW}Examples:${NC}
  sytex-db test
  sytex-db tables
  sytex-db describe tasks
  sytex-db query "SELECT * FROM tasks WHERE status = 'open' LIMIT 10"
  sytex-db query "SELECT COUNT(*) FROM users" json
  sytex-db tasks 50
  sytex-db stats

${YELLOW}Notes:${NC}
  - Only SELECT, SHOW, DESCRIBE, and EXPLAIN queries are allowed
  - All queries are read-only for safety
  - Make sure your database user has SELECT permissions only
EOF
}

# Check if we need credentials (not needed for help command)
if [[ "${1:-}" == "help" ]] || [[ "${1:-}" == "--help" ]] || [[ "${1:-}" == "-h" ]]; then
    cmd_help
    exit 0
fi

# Load environment variables
if [[ -f "$ENV_FILE" ]]; then
    set -a
    source "$ENV_FILE"
    set +a
else
    echo -e "${RED}Error: .env file not found at $ENV_FILE${NC}"
    echo "Run the installer to configure database credentials."
    exit 1
fi

# Check required variables
if [[ -z "${DB_HOST:-}" || -z "${DB_NAME:-}" || -z "${DB_USER:-}" || -z "${DB_PASSWORD:-}" ]]; then
    echo -e "${RED}Error: Missing required environment variables${NC}"
    echo "Required: DB_HOST, DB_NAME, DB_USER, DB_PASSWORD"
    exit 1
fi

DB_PORT="${DB_PORT:-3306}"

# Check if mysql client is installed
if ! command -v mysql &> /dev/null; then
    echo -e "${RED}Error: mysql client not found${NC}"
    echo "Install it with: brew install mysql-client (macOS) or apt-get install mysql-client (Linux)"
    exit 1
fi

# Execute MySQL query with proper error handling
execute_query() {
    local query="$1"
    local format="${2:-table}"  # table, json, csv

    local mysql_opts=(
        --host="$DB_HOST"
        --port="$DB_PORT"
        --user="$DB_USER"
        --password="$DB_PASSWORD"
        --database="$DB_NAME"
    )

    case "$format" in
        json)
            mysql_opts+=(--json)
            ;;
        csv)
            mysql_opts+=(--batch --skip-column-names)
            ;;
        table)
            mysql_opts+=(--table)
            ;;
    esac

    if ! echo "$query" | mysql "${mysql_opts[@]}" 2>&1; then
        return 1
    fi
}

# Test connection
cmd_test() {
    echo -e "${BLUE}Testing database connection...${NC}"
    if execute_query "SELECT 1 AS connection_test;" > /dev/null 2>&1; then
        echo -e "${GREEN}✓ Connection successful${NC}"
        echo -e "${BLUE}Database: ${NC}$DB_NAME"
        echo -e "${BLUE}Host: ${NC}$DB_HOST:$DB_PORT"
        echo -e "${BLUE}User: ${NC}$DB_USER"
    else
        echo -e "${RED}✗ Connection failed${NC}"
        exit 1
    fi
}

# List all tables
cmd_tables() {
    echo -e "${BLUE}Tables in database '$DB_NAME':${NC}"
    execute_query "SHOW TABLES;"
}

# Describe table schema
cmd_describe() {
    local table="$1"
    if [[ -z "$table" ]]; then
        echo -e "${RED}Error: Table name required${NC}"
        echo "Usage: sytex-db describe <table_name>"
        exit 1
    fi

    echo -e "${BLUE}Schema for table '$table':${NC}"
    execute_query "DESCRIBE \`$table\`;"

    echo ""
    echo -e "${BLUE}Indexes for table '$table':${NC}"
    execute_query "SHOW INDEXES FROM \`$table\`;"
}

# Execute a custom query
cmd_query() {
    local query="$1"
    local format="${2:-table}"

    if [[ -z "$query" ]]; then
        echo -e "${RED}Error: Query required${NC}"
        echo "Usage: sytex-db query \"SELECT * FROM table LIMIT 10\" [format]"
        echo "Formats: table (default), json, csv"
        exit 1
    fi

    # Validate it's a SELECT query (read-only)
    if ! echo "$query" | grep -iE '^\s*(SELECT|SHOW|DESCRIBE|EXPLAIN)' > /dev/null; then
        echo -e "${RED}Error: Only SELECT, SHOW, DESCRIBE, and EXPLAIN queries are allowed${NC}"
        exit 1
    fi

    execute_query "$query" "$format"
}

# Predefined queries
cmd_tasks() {
    local limit="${1:-20}"
    echo -e "${BLUE}Recent tasks (limit: $limit):${NC}"
    execute_query "SELECT id, title, status, created_at, updated_at FROM tasks ORDER BY updated_at DESC LIMIT $limit;"
}

cmd_projects() {
    local limit="${1:-20}"
    echo -e "${BLUE}Recent projects (limit: $limit):${NC}"
    execute_query "SELECT id, name, status, created_at, updated_at FROM projects ORDER BY updated_at DESC LIMIT $limit;"
}

cmd_users() {
    local limit="${1:-50}"
    echo -e "${BLUE}Users (limit: $limit):${NC}"
    execute_query "SELECT id, name, email, created_at FROM users ORDER BY created_at DESC LIMIT $limit;"
}

cmd_stats() {
    echo -e "${BLUE}Database statistics:${NC}"
    echo ""

    echo -e "${BLUE}Table row counts:${NC}"
    execute_query "
        SELECT
            table_name AS 'Table',
            table_rows AS 'Approximate Rows'
        FROM information_schema.tables
        WHERE table_schema = '$DB_NAME'
        ORDER BY table_rows DESC;
    "
}

# Main command dispatcher
main() {
    local cmd="${1:-help}"
    shift || true

    case "$cmd" in
        test)
            cmd_test
            ;;
        tables|list)
            cmd_tables
            ;;
        describe|desc|schema)
            cmd_describe "$@"
            ;;
        query|q)
            cmd_query "$@"
            ;;
        tasks)
            cmd_tasks "$@"
            ;;
        projects)
            cmd_projects "$@"
            ;;
        users)
            cmd_users "$@"
            ;;
        stats|statistics)
            cmd_stats
            ;;
        help|--help|-h)
            cmd_help
            ;;
        *)
            echo -e "${RED}Error: Unknown command '$cmd'${NC}"
            echo "Run 'sytex-db help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
