#!/bin/bash
# Sytex API CLI

CONFIG_FILE="$HOME/.claude/skills/sytex/.env"
source "$CONFIG_FILE" 2>/dev/null

if [[ -z "$SYTEX_TOKEN" ]]; then
    echo "Error: Not configured. Create $CONFIG_FILE with SYTEX_TOKEN"
    exit 1
fi

# Parse global flags (--org and --base-url) before command
SYTEX_ORG_ID=""
SYTEX_BASE_URL=""

args=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --org) SYTEX_ORG_ID="$2"; shift 2 ;;
        --base-url) SYTEX_BASE_URL="$2"; shift 2 ;;
        *) args+=("$1"); shift ;;
    esac
done
set -- "${args[@]}"

# Commands that don't require --org and --base-url
NO_FLAGS_COMMANDS="find-org"
# Commands that only require --base-url (not --org)
BASE_URL_ONLY_COMMANDS="orgs"

if [[ " $NO_FLAGS_COMMANDS " == *" $1 "* ]]; then
    : # No flags required
elif [[ " $BASE_URL_ONLY_COMMANDS " == *" $1 "* ]]; then
    [[ -z "$SYTEX_BASE_URL" ]] && echo "Error: --base-url required" && exit 1
else
    [[ -z "$SYTEX_BASE_URL" ]] && echo "Error: --base-url required" && exit 1
    [[ -z "$SYTEX_ORG_ID" ]] && echo "Error: --org required" && exit 1
fi

API_BASE="${SYTEX_BASE_URL}/api"

[[ -n "$SYTEX_ORG_ID" ]] && echo "[Sytex] Organization: $SYTEX_ORG_ID | Base: $SYTEX_BASE_URL" >&2

# HTTP request helpers
api_get() {
    local endpoint="$1"
    curl -s -X GET "${API_BASE}${endpoint}" \
        -H "Authorization: Token $SYTEX_TOKEN" \
        -H "Organization: $SYTEX_ORG_ID" \
        -H "Accept: application/json"
}

api_post() {
    local endpoint="$1"
    local data="$2"
    curl -s -X POST "${API_BASE}${endpoint}" \
        -H "Authorization: Token $SYTEX_TOKEN" \
        -H "Organization: $SYTEX_ORG_ID" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -d "$data"
}

api_put() {
    local endpoint="$1"
    local data="$2"
    curl -s -X PUT "${API_BASE}${endpoint}" \
        -H "Authorization: Token $SYTEX_TOKEN" \
        -H "Organization: $SYTEX_ORG_ID" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -d "$data"
}

api_patch() {
    local endpoint="$1"
    local data="$2"
    curl -s -X PATCH "${API_BASE}${endpoint}" \
        -H "Authorization: Token $SYTEX_TOKEN" \
        -H "Organization: $SYTEX_ORG_ID" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -d "$data"
}

api_delete() {
    local endpoint="$1"
    curl -s -X DELETE "${API_BASE}${endpoint}" \
        -H "Authorization: Token $SYTEX_TOKEN" \
        -H "Organization: $SYTEX_ORG_ID" \
        -H "Accept: application/json"
}

# URL encode helper
url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('$1'))"
}

# Build query string from key=value pairs
build_query() {
    local query=""
    for param in "$@"; do
        [[ -n "$query" ]] && query="${query}&"
        query="${query}${param}"
    done
    echo "$query"
}

# === TASKS ===

cmd_tasks() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --status) params+=("status=$2"); shift 2 ;;
            --project) params+=("project=$2"); shift 2 ;;
            --assigned-staff) params+=("assigned_staff=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/task/${query}"
}

cmd_task() {
    local task_id="$1"
    [[ -z "$task_id" ]] && echo "Error: task ID required" && exit 1
    api_get "/task/${task_id}/"
}

cmd_task_update() {
    local task_id="$1"
    local data="$2"
    [[ -z "$task_id" ]] && echo "Error: task ID required" && exit 1
    [[ -z "$data" ]] && echo "Error: JSON data required" && exit 1
    api_patch "/task/${task_id}/" "$data"
}

cmd_task_status() {
    local code="$1"
    local status="$2"
    [[ -z "$code" || -z "$status" ]] && echo "Error: code and status required" && exit 1
    api_post "/import/TaskImport/go/" "{\"code\": \"$code\", \"status_step\": \"$status\"}"
}

cmd_task_create() {
    local data="$1"
    [[ -z "$data" ]] && echo "Error: JSON data required" && exit 1
    api_post "/task/" "$data"
}

# === PROJECTS ===

cmd_projects() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/project/${query}"
}

cmd_project() {
    local project_id="$1"
    [[ -z "$project_id" ]] && echo "Error: project ID required" && exit 1
    api_get "/project/${project_id}/"
}

# === SITES ===

cmd_sites() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --status) params+=("status=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/site/${query}"
}

cmd_site() {
    local site_id="$1"
    [[ -z "$site_id" ]] && echo "Error: site ID required" && exit 1
    api_get "/site/${site_id}/"
}

# === MATERIALS ===

cmd_materials() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/material/${query}"
}

cmd_material_ops() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --status) params+=("status=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/materialoperation/${query}"
}

cmd_mo_status() {
    local code="$1"
    local status="$2"
    [[ -z "$code" || -z "$status" ]] && echo "Error: code and status required" && exit 1
    api_post "/import/SimpleOperationImport/go/" "{\"code\": \"$code\", \"status_step\": \"$status\"}"
}

cmd_mo_add_item() {
    local data="$1"
    [[ -z "$data" ]] && echo "Error: JSON data required" && exit 1
    api_post "/import/SimpleOperationItemImport/go/" "$data"
}

# === FORMS ===

cmd_forms() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --status) params+=("status=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/form/${query}"
}

cmd_form() {
    local form_id="$1"
    [[ -z "$form_id" ]] && echo "Error: form ID required" && exit 1
    api_get "/form/${form_id}/"
}

# === STAFF ===

cmd_staff() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/staff/${query}"
}

cmd_user_roles() {
    local search="$1"
    [[ -z "$search" ]] && echo "Error: search term required" && exit 1

    # Use last word (usually surname) for better search results
    local search_term="${search##* }"

    # Search staff by name
    local staff_result=$(api_get "/staff/?q=$(url_encode "$search_term")&limit=10")

    # Find user matching all words in search term
    local user_id=$(echo "$staff_result" | jq -r --arg search "$search" '
        ($search | ascii_downcase | gsub("\\s+"; " ") | split(" ")) as $words |
        .results[] |
        select(
            .name as $name |
            ($name | ascii_downcase | gsub("\\s+"; " ")) as $normalized |
            all($words[]; . as $word | $normalized | contains($word))
        ) |
        .related_user_id
    ' | head -1)

    # Fallback to first result if no match
    [[ -z "$user_id" ]] && user_id=$(echo "$staff_result" | jq -r '.results[0].related_user_id // empty')

    [[ -z "$user_id" ]] && echo "Error: user not found for '$search'" && exit 1

    # Get user roles
    api_get "/userrole/?user=${user_id}&limit=100"
}

# === AUTOMATIONS ===

cmd_automation() {
    local uuid="$1"
    local data="$2"
    [[ -z "$uuid" ]] && echo "Error: automation UUID required" && exit 1
    [[ -z "$data" ]] && data="{}"
    api_post "/automation/${uuid}/execute/" "$data"
}

# === CUSTOM FIELDS ===

cmd_customfields() {
    local model=""
    local object_id=""
    local limit=100

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --model) model="$2"; shift 2 ;;
            --object-id) object_id="$2"; shift 2 ;;
            --limit) limit="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    [[ -z "$model" || -z "$object_id" ]] && echo "Error: --model and --object-id required" && exit 1
    api_get "/customfield/?content_type__model=${model}&object_id=${object_id}&limit=${limit}"
}

# === TASK TEMPLATES ===

cmd_tasktemplates() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/tasktemplate/${query}"
}

cmd_tasktemplate() {
    local id="$1"
    [[ -z "$id" ]] && echo "Error: tasktemplate ID required" && exit 1
    api_get "/tasktemplate/${id}/"
}

# === WORKSTRUCTURES ===

cmd_workstructures() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --code) params+=("code=$2"); shift 2 ;;
            --project) params+=("project=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/workstructure/${query}"
}

cmd_workstructure() {
    local ws_id="$1"
    [[ -z "$ws_id" ]] && echo "Error: workstructure ID required" && exit 1
    api_get "/workstructure/${ws_id}/"
}

cmd_workstructure_tasks() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            --workstructure) params+=("workstructure=$2"); shift 2 ;;
            --ordering) params+=("ordering=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/workstructuretask/${query}"
}

cmd_workstructure_task() {
    local wst_id="$1"
    [[ -z "$wst_id" ]] && echo "Error: workstructure task ID required" && exit 1
    api_get "/workstructuretask/${wst_id}/"
}

# === ORGANIZATIONS ===

cmd_orgs() {
    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --limit) params+=("limit=$2"); shift 2 ;;
            --offset) params+=("offset=$2"); shift 2 ;;
            --q) params+=("q=$(url_encode "$2")"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=$(build_query "${params[@]}")
    [[ -n "$query" ]] && query="?$query"
    api_get "/organization/${query}"
}

cmd_find_org() {
    local search="$1"
    [[ -z "$search" ]] && echo "Error: search term required" && exit 1

    local instances=(
        "app:https://app.sytex.io"
        "claro:https://claro.sytex.io"
        "ufinet:https://ufinet.sytex.io"
        "dt:https://dt.sytex.io"
        "adc:https://adc.sytex.io"
        "atis:https://atis.sytex.io"
        "exsei:https://exsei.sytex.io"
        "integrar:https://integrar.sytex.io"
        "torresec:https://torresec.sytex.io"
        "app_eu:https://app.eu.sytex.io"
    )

    echo "Searching for '$search' across all instances..." >&2
    echo "{"
    echo "  \"search\": \"$search\","
    echo "  \"results\": ["

    local first=true
    for instance in "${instances[@]}"; do
        local name="${instance%%:*}"
        local url="${instance#*:}"

        local result=$(curl -s -X GET "${url}/api/organization/?q=$(url_encode "$search")&limit=10" \
            -H "Authorization: Token $SYTEX_TOKEN" \
            -H "Accept: application/json" 2>/dev/null)

        local count=$(echo "$result" | jq -r '.count // 0' 2>/dev/null)
        [[ "$count" == "0" || "$count" == "null" ]] && continue

        local orgs=$(echo "$result" | jq -c '.results[]? | {id, name}' 2>/dev/null)
        [[ -z "$orgs" ]] && continue

        while IFS= read -r org; do
            [[ -z "$org" ]] && continue
            local org_id=$(echo "$org" | jq -r '.id')
            local org_name=$(echo "$org" | jq -r '.name')

            [[ "$first" != "true" ]] && echo ","
            first=false
            echo "    {\"instance\": \"$name\", \"base_url\": \"$url\", \"org_id\": $org_id, \"org_name\": \"$org_name\"}"
        done <<< "$orgs"
    done

    echo ""
    echo "  ]"
    echo "}"
}

# === GENERIC ===

cmd_get() {
    local endpoint="$1"
    [[ -z "$endpoint" ]] && echo "Error: endpoint required" && exit 1
    # Ensure endpoint starts with /
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_get "$endpoint"
}

cmd_post() {
    local endpoint="$1"
    local data="$2"
    [[ -z "$endpoint" ]] && echo "Error: endpoint required" && exit 1
    [[ -z "$data" ]] && data="{}"
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_post "$endpoint" "$data"
}

cmd_put() {
    local endpoint="$1"
    local data="$2"
    [[ -z "$endpoint" || -z "$data" ]] && echo "Error: endpoint and data required" && exit 1
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_put "$endpoint" "$data"
}

cmd_patch() {
    local endpoint="$1"
    local data="$2"
    [[ -z "$endpoint" || -z "$data" ]] && echo "Error: endpoint and data required" && exit 1
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_patch "$endpoint" "$data"
}

cmd_delete() {
    local endpoint="$1"
    [[ -z "$endpoint" ]] && echo "Error: endpoint required" && exit 1
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_delete "$endpoint"
}

# === MAIN ===

show_help() {
    echo "Sytex API CLI"
    echo ""
    echo "TASKS:"
    echo "  tasks [--limit N] [--q QUERY] [--status ID] [--project ID]"
    echo "  task <id>                          Get task details"
    echo "  task-update <id> <json>            Update task (PATCH)"
    echo "  task-status <code> <status>        Update task status by code"
    echo "  task-create <json>                 Create new task"
    echo ""
    echo "PROJECTS:"
    echo "  projects [--limit N] [--q QUERY]   List projects"
    echo "  project <id>                       Get project details"
    echo ""
    echo "SITES:"
    echo "  sites [--limit N] [--q QUERY]      List sites"
    echo "  site <id>                          Get site details"
    echo ""
    echo "MATERIALS:"
    echo "  materials [--limit N] [--q QUERY]  List materials"
    echo "  material-ops [--limit N]           List material operations"
    echo "  mo-status <code> <status>          Update MO status"
    echo "  mo-add-item <json>                 Add item to MO"
    echo ""
    echo "FORMS:"
    echo "  forms [--limit N] [--q QUERY]      List forms"
    echo "  form <id>                          Get form details"
    echo ""
    echo "STAFF:"
    echo "  staff [--limit N] [--q QUERY]      List staff members"
    echo "  user-roles <name>                  Get roles for a user by name"
    echo ""
    echo "CUSTOM FIELDS:"
    echo "  customfields --model MODEL --object-id ID [--limit N]"
    echo "    Models: workstructure, task, project, site, client, staff, etc."
    echo ""
    echo "TASK TEMPLATES (simple reusable templates):"
    echo "  tasktemplates [--limit N] [--q QUERY]"
    echo "  tasktemplate <id>                  Get task template details"
    echo ""
    echo "WORKSTRUCTURES (workflows with task hierarchies):"
    echo "  workstructures [--limit N] [--q QUERY] [--code CODE] [--project ID]"
    echo "  workstructure <id>                 Get workstructure details"
    echo "  workstructure-tasks [--limit N] [--workstructure ID]"
    echo "  workstructure-task <id>            Get workstructure task template details"
    echo ""
    echo "AUTOMATIONS:"
    echo "  automation <uuid> [json]           Execute automation"
    echo ""
    echo "ORGANIZATIONS:"
    echo "  orgs [--q QUERY]                   List organizations in current instance"
    echo "  find-org <name>                    Search org by name across ALL instances"
    echo ""
    echo "GENERIC (for any endpoint):"
    echo "  get <endpoint>                     GET request"
    echo "  post <endpoint> [json]             POST request"
    echo "  put <endpoint> <json>              PUT request"
    echo "  patch <endpoint> <json>            PATCH request"
    echo "  delete <endpoint>                  DELETE request"
    echo ""
    echo "COMMON FLAGS:"
    echo "  --limit N       Results per page"
    echo "  --offset N      Skip first N results"
    echo "  --q QUERY       Search text"
    echo "  --ordering FIELD  Sort by field (prefix with - for desc)"
}

case "$1" in
    tasks) shift; cmd_tasks "$@" ;;
    task) cmd_task "$2" ;;
    task-update) cmd_task_update "$2" "$3" ;;
    task-status) cmd_task_status "$2" "$3" ;;
    task-create) cmd_task_create "$2" ;;
    projects) shift; cmd_projects "$@" ;;
    project) cmd_project "$2" ;;
    sites) shift; cmd_sites "$@" ;;
    site) cmd_site "$2" ;;
    materials) shift; cmd_materials "$@" ;;
    material-ops) shift; cmd_material_ops "$@" ;;
    mo-status) cmd_mo_status "$2" "$3" ;;
    mo-add-item) cmd_mo_add_item "$2" ;;
    forms) shift; cmd_forms "$@" ;;
    form) cmd_form "$2" ;;
    staff) shift; cmd_staff "$@" ;;
    user-roles) cmd_user_roles "$2" ;;
    automation) cmd_automation "$2" "$3" ;;
    customfields) shift; cmd_customfields "$@" ;;
    tasktemplates) shift; cmd_tasktemplates "$@" ;;
    tasktemplate) cmd_tasktemplate "$2" ;;
    workstructures) shift; cmd_workstructures "$@" ;;
    workstructure) cmd_workstructure "$2" ;;
    workstructure-tasks) shift; cmd_workstructure_tasks "$@" ;;
    workstructure-task) cmd_workstructure_task "$2" ;;
    get) cmd_get "$2" ;;
    post) cmd_post "$2" "$3" ;;
    put) cmd_put "$2" "$3" ;;
    patch) cmd_patch "$2" "$3" ;;
    delete) cmd_delete "$2" ;;
    orgs) shift; cmd_orgs "$@" ;;
    find-org) cmd_find_org "$2" ;;
    *) show_help; exit 1 ;;
esac
