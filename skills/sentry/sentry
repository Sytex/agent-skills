#!/bin/bash
# Sentry API CLI - Multi-org support

set -e

CONFIG_FILE="$HOME/.claude/skills/sentry/.env"

# Load config
if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "Error: Not configured. Run the installer to add Sentry organizations."
    exit 1
fi

source "$CONFIG_FILE" 2>/dev/null

# Parse global --org flag first
SELECTED_ORG=""
ARGS=()
while [[ $# -gt 0 ]]; do
    case "$1" in
        --org)
            SELECTED_ORG="$2"
            shift 2
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done
set -- "${ARGS[@]}"

# Function to get org config
get_org_config() {
    local org_slug="$1"
    local field="$2"

    # Config format: SENTRY_ORG_<SLUG>_TOKEN, SENTRY_ORG_<SLUG>_URL
    local slug_upper=$(echo "$org_slug" | tr '[:lower:]-' '[:upper:]_')
    local var_name="SENTRY_ORG_${slug_upper}_${field}"
    echo "${!var_name}"
}

# Get list of configured orgs
get_configured_orgs() {
    env | grep -oP 'SENTRY_ORG_\K[A-Z0-9_]+(?=_TOKEN)' | tr '[:upper:]_' '[:lower:]-' | sort -u
}

# Resolve which org to use
resolve_org() {
    if [[ -n "$SELECTED_ORG" ]]; then
        echo "$SELECTED_ORG"
        return
    fi

    if [[ -n "$SENTRY_DEFAULT_ORG" ]]; then
        echo "$SENTRY_DEFAULT_ORG"
        return
    fi

    # Use first configured org
    get_configured_orgs | head -1
}

# Set up API for current org
ORG=$(resolve_org)

if [[ -z "$ORG" ]]; then
    echo "Error: No organizations configured. Run the installer to add one."
    exit 1
fi

SENTRY_TOKEN=$(get_org_config "$ORG" "TOKEN")
SENTRY_BASE_URL=$(get_org_config "$ORG" "URL")

if [[ -z "$SENTRY_TOKEN" ]]; then
    echo "Error: Organization '$ORG' not found in config."
    echo "Configured orgs: $(get_configured_orgs | tr '\n' ' ')"
    exit 1
fi

API_BASE="${SENTRY_BASE_URL:-https://sentry.io}/api/0"

# HTTP helpers
api_get() {
    local endpoint="$1"
    curl -s -X GET "${API_BASE}${endpoint}" \
        -H "Authorization: Bearer $SENTRY_TOKEN" \
        -H "Accept: application/json"
}

api_put() {
    local endpoint="$1"
    local data="$2"
    curl -s -X PUT "${API_BASE}${endpoint}" \
        -H "Authorization: Bearer $SENTRY_TOKEN" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -d "$data"
}

api_delete() {
    local endpoint="$1"
    curl -s -X DELETE "${API_BASE}${endpoint}" \
        -H "Authorization: Bearer $SENTRY_TOKEN" \
        -H "Accept: application/json"
}

url_encode() {
    python3 -c "import urllib.parse; print(urllib.parse.quote('$1'))"
}

# === ORGANIZATIONS ===

cmd_orgs() {
    echo "Configured organizations:"
    echo ""
    local current_org=$(resolve_org)
    while IFS= read -r org; do
        local token=$(get_org_config "$org" "TOKEN")
        local url=$(get_org_config "$org" "URL")
        local marker=""
        [[ "$org" == "$current_org" ]] && marker=" (active)"
        echo "  - $org$marker"
        echo "    URL: ${url:-https://sentry.io}"
        # Test connection
        local test_url="${url:-https://sentry.io}/api/0/organizations/$org/"
        local result=$(curl -s -o /dev/null -w "%{http_code}" "$test_url" \
            -H "Authorization: Bearer $token" \
            -H "Accept: application/json")
        if [[ "$result" == "200" ]]; then
            echo "    Status: connected"
        else
            echo "    Status: error (HTTP $result)"
        fi
        echo ""
    done < <(get_configured_orgs)
}

# === PROJECTS ===

cmd_projects() {
    api_get "/projects/"
}

cmd_project() {
    local project="$1"
    [[ -z "$project" ]] && echo "Error: project slug required" && exit 1
    api_get "/projects/${ORG}/${project}/"
}

# === ISSUES ===

cmd_issues() {
    local params=()
    local project=""
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --project) project="$2"; shift 2 ;;
            --query) params+=("query=$(url_encode "$2")"); shift 2 ;;
            --status) params+=("query=$(url_encode "is:$2")"); shift 2 ;;
            --env) params+=("environment=$2"); shift 2 ;;
            --limit) params+=("limit=$2"); shift 2 ;;
            --sort) params+=("sort=$2"); shift 2 ;;
            --cursor) params+=("cursor=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=""
    for param in "${params[@]}"; do
        [[ -n "$query" ]] && query="${query}&"
        query="${query}${param}"
    done
    [[ -n "$query" ]] && query="?$query"

    if [[ -n "$project" ]]; then
        api_get "/projects/${ORG}/${project}/issues/${query}"
    else
        api_get "/organizations/${ORG}/issues/${query}"
    fi
}

cmd_issue() {
    local issue_id="$1"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1
    api_get "/organizations/${ORG}/issues/${issue_id}/"
}

cmd_events() {
    local issue_id="$1"
    shift
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1

    local params=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --full) params+=("full=true"); shift ;;
            --limit) params+=("limit=$2"); shift 2 ;;
            --cursor) params+=("cursor=$2"); shift 2 ;;
            *) shift ;;
        esac
    done

    local query=""
    for param in "${params[@]}"; do
        [[ -n "$query" ]] && query="${query}&"
        query="${query}${param}"
    done
    [[ -n "$query" ]] && query="?$query"

    api_get "/organizations/${ORG}/issues/${issue_id}/events/${query}"
}

cmd_event() {
    local project="$1"
    local event_id="$2"
    [[ -z "$project" ]] && echo "Error: project slug required" && exit 1
    [[ -z "$event_id" ]] && echo "Error: event ID required" && exit 1
    api_get "/projects/${ORG}/${project}/events/${event_id}/"
}

# === ISSUE ACTIONS ===

cmd_resolve() {
    local issue_id="$1"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1
    api_put "/organizations/${ORG}/issues/${issue_id}/" '{"status": "resolved"}'
}

cmd_unresolve() {
    local issue_id="$1"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1
    api_put "/organizations/${ORG}/issues/${issue_id}/" '{"status": "unresolved"}'
}

cmd_ignore() {
    local issue_id="$1"
    local duration="${2:-}"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1

    if [[ -n "$duration" ]]; then
        api_put "/organizations/${ORG}/issues/${issue_id}/" "{\"status\": \"ignored\", \"statusDetails\": {\"ignoreDuration\": $duration}}"
    else
        api_put "/organizations/${ORG}/issues/${issue_id}/" '{"status": "ignored"}'
    fi
}

cmd_assign() {
    local issue_id="$1"
    local assignee="$2"
    [[ -z "$issue_id" ]] && echo "Error: issue ID required" && exit 1
    [[ -z "$assignee" ]] && echo "Error: assignee required (user ID or team:name)" && exit 1
    api_put "/organizations/${ORG}/issues/${issue_id}/" "{\"assignedTo\": \"$assignee\"}"
}

# === STATS ===

cmd_stats() {
    local stat="received"
    local period="24h"
    local project=""

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --stat) stat="$2"; shift 2 ;;
            --period) period="$2"; shift 2 ;;
            --project) project="$2"; shift 2 ;;
            *) shift ;;
        esac
    done

    local query="stat=${stat}&statsPeriod=${period}"
    [[ -n "$project" ]] && query="${query}&project=${project}"

    api_get "/organizations/${ORG}/stats_v2/?${query}"
}

# === GENERIC ===

cmd_get() {
    local endpoint="$1"
    [[ -z "$endpoint" ]] && echo "Error: endpoint required" && exit 1
    [[ "$endpoint" != /* ]] && endpoint="/$endpoint"
    api_get "$endpoint"
}

# === MAIN ===

show_help() {
    echo "Sentry API CLI (Multi-org)"
    echo ""
    echo "GLOBAL FLAGS:"
    echo "  --org <slug>    Organization slug (default: $SENTRY_DEFAULT_ORG or first configured)"
    echo ""
    echo "ORGANIZATIONS:"
    echo "  orgs                        List configured organizations"
    echo ""
    echo "PROJECTS:"
    echo "  projects                    List all projects"
    echo "  project <slug>              Get project details"
    echo ""
    echo "ISSUES:"
    echo "  issues [flags]              List issues"
    echo "    --project <slug>          Filter by project"
    echo "    --query <search>          Search query (Sentry syntax)"
    echo "    --status <status>         unresolved, resolved, ignored"
    echo "    --env <name>              Filter by environment"
    echo "    --sort <field>            date, freq, new, user"
    echo "    --limit <n>               Max results (max 100)"
    echo "  issue <id>                  Get issue details"
    echo ""
    echo "EVENTS:"
    echo "  events <issue_id> [flags]   List events for an issue"
    echo "    --full                    Include full stacktrace"
    echo "    --limit <n>               Max results"
    echo "  event <project> <event_id>  Get event details"
    echo ""
    echo "ACTIONS:"
    echo "  resolve <issue_id>          Mark issue as resolved"
    echo "  unresolve <issue_id>        Reopen issue"
    echo "  ignore <issue_id> [mins]    Ignore issue (optionally for N minutes)"
    echo "  assign <issue_id> <user>    Assign issue"
    echo ""
    echo "STATS:"
    echo "  stats [flags]               Get organization stats"
    echo "    --stat <type>             received, rejected, blacklisted"
    echo "    --period <period>         24h, 7d, 30d"
    echo "    --project <id>            Filter by project ID"
    echo ""
    echo "GENERIC:"
    echo "  get <endpoint>              GET any endpoint"
    echo ""
    echo "EXAMPLES:"
    echo "  sentry orgs                           # List all configured orgs"
    echo "  sentry --org sytex-eu issues          # Issues from sytex-eu"
    echo "  sentry issues --status unresolved     # Unresolved issues (default org)"
    echo ""
    echo "SEARCH QUERY SYNTAX:"
    echo "  is:unresolved               Unresolved issues"
    echo "  is:resolved                 Resolved issues"
    echo "  is:ignored                  Ignored issues"
    echo "  is:assigned                 Assigned to someone"
    echo "  assigned:me                 Assigned to me"
    echo "  level:error                 Error level"
    echo "  environment:production      By environment"
    echo "  release:1.0.0               By release"
    echo "  user.email:foo@bar.com      By user email"
}

case "$1" in
    orgs) cmd_orgs ;;
    projects) cmd_projects ;;
    project) cmd_project "$2" ;;
    issues) shift; cmd_issues "$@" ;;
    issue) cmd_issue "$2" ;;
    events) shift; cmd_events "$@" ;;
    event) cmd_event "$2" "$3" ;;
    resolve) cmd_resolve "$2" ;;
    unresolve) cmd_unresolve "$2" ;;
    ignore) cmd_ignore "$2" "$3" ;;
    assign) cmd_assign "$2" "$3" ;;
    stats) shift; cmd_stats "$@" ;;
    get) cmd_get "$2" ;;
    *) show_help ;;
esac
